;--------------------------------
; PSG(AY-3-8910) MUSIC PLAYER
; (MSX VERSION) (C)1991 m@3
; (For MSX VRAM 16K/RAM 32K)
; VERSION 3.5Z+0.031(¼­³¾²ÊÞÝ2+1)
;--------------------------------
;	CSEG
	ASEG

WRTPSG	EQU	0093H
PSGDATA	EQU	0DB3EH;TONE
MBOOT	EQU	0DB00H;
;MDATA	EQU	0DBFFH;PLAY DATA
HOOK	EQU	0FD9FH
PARTSUU	EQU	3
FEEDTIME EQU	12
	ORG	0DC00H

	LD	HL,(0F7F8H)
INITIAL:XOR	A
	LD	(FEEDVOL),A
	LD	(STOPPARTS),A
	LD	(ENDFRG),A
	LD	A,L
	INC	A
	LD	(NSAVE),A
	JP	Z,STOP
	INC	A
	JR	Z,FEEDO

	DI
	PUSH	HL
	LD	A,H
	LD	(LOOPTIME),A
	CALL	PSGOFF
	LD	DE,HOOKWRK
	LD	A,(DE)
	OR	A
	JR	NZ,NOSAVE
	LD	BC,5
	LD	HL,HOOK
	LDIR

NOSAVE:	POP	HL

	SLA	L
	SLA	L
	SLA	L

	LD	C,L
	LD	B,0
	LD	HL,MBOOT
	ADD	HL,BC

	LD	B,PARTSUU;CALL	SETLOOPS

INILP:	XOR	A
	PUSH	BC
	LD	C,B
	DEC	C
	LD	B,A

	LD	E,(HL)
	INC	HL
	LD	D,(HL)
	INC	HL
	PUSH	HL
	CP	D

	JR	NZ,PASS1
	CALL	SYNCFGON
	DEC	A	;A=255
PASS1:	LD	HL,MAXVOL
	ADD	HL,BC
	LD	(HL),A
	LD	HL,COUNT
	ADD	HL,BC
	LD	(HL),1
	LD	HL,STOPFRG
	ADD	HL,BC
	LD	(HL),A

	;OFFSET<-STARTADR

;	CALL	SADGET

	LD	HL,STARTADR
	ADD	HL,BC
	ADD	HL,BC

	LD	(HL),E
	INC	HL
	LD	(HL),D

	LD	HL,OFFSET
	ADD	HL,BC
	ADD	HL,BC

	LD	(HL),E
	INC	HL
	LD	(HL),D

	POP	HL
	POP	BC
	DJNZ	INILP

	LD	HL,HOOK
	LD	BC,PLAYLOOP

	LD	(HL),0C3H
	INC	HL
	LD	(HL),C
	INC	HL
	LD	(HL),B
	EI
	RET

FEEDO:	LD	A,1
	LD	(FEEDVOL),A
	LD	(FCOUNT),A

	LD	B,PARTSUU;CALL	SETLOOPS

;	LD	E,0
FEEDLOOP:PUSH	BC
	LD	HL,MAXVOL
	LD	C,B
	DEC	C
	LD	B,0
	ADD	HL,BC
	LD	A,(HL)
	INC	A
	JR	Z,NOFELFO
	CP	16+1
	JR	C,NOFELFO
	LD	A,15
	LD	(HL),A
NOFELFO:POP	BC
	DJNZ	FEEDLOOP
	RET

;SADGET:LD	HL,STARTADR
;	ADD	HL,BC
;	ADD	HL,BC
;	RET

STOP:	LD	HL,HOOKWRK
	XOR	A
	CP	(HL)
	RET	Z
	LD	DE,HOOK
	LD	BC,5
	PUSH	HL
	DI
	LDIR
	EI
	POP	HL
	LD	(HL),A;0

PSGOFF:	LD	HL,MAXVOL
	LD	B,PARTSUU;CALL	SETLOOPS

OFFLP:	LD	A,(HL)
	INC	A
	JR	Z,OFLPED
	LD	A,11
	SUB	B
	LD	E,0
	CALL	WRTPSG
	INC	HL
OFLPED:	DJNZ	OFFLP
	RET

FEEDSUB:LD	HL,FCOUNT
	DEC	(HL)
	RET	NZ
;	LD	A,(FEEDTIME)
	LD	(HL),FEEDTIME

	LD	HL,FEEDVOL
;	LD	A,(HL)
;	CP	15
;	JR	Z,STOP
	INC	(HL)

	LD	HL,MAXVOL
	ADD	HL,BC
	LD	A,(HL)
	INC	A
	RET	Z

	CP	16
	CALL	C,PUTVOL
	RET

;<ºº¶×¶Þ ÜØºÐÃÞ ÖÊÞÚÙ Ù-ÁÝÃÞ½>

PLAYLOOP:LD	A,(FEEDVOL)
	CP	15
	JR	Z,STOP
	OR	A
	CALL	NZ,FEEDSUB
	LD	B,PARTSUU;CALL	SETLOOPS

COUNTER:PUSH	BC

	LD	C,B
	DEC	C
	LD	B,0	;BC=B-1

	LD	HL,STOPFRG
	ADD	HL,BC
	LD	A,(HL)
	CP	254
	JR	NC,LOOPEND

;	LD	HL,MAXVOL
;	LD	A,(HL)
;	INC	A
;	JR	Z,LOOPEND

	LD	HL,COUNT
	ADD	HL,BC	;BC ÆÊ P-No.
	DEC	(HL)
	CALL	Z,PING

LOOPEND:POP	BC
	DJNZ	COUNTER

	LD	B,PARTSUU
	LD	A,(STOPPARTS)
	CP	B
	JR	NZ,PSTOP
	LD	C,B

	LD	HL,STOPFRG
	LD	DE,COUNT
LPE:	LD	A,(HL)
	INC	A
;	CP	255
	JR	Z,LPNX
	XOR	A
	LD	(HL),A
	INC	A
	LD	(DE),A
	DEC	C
LPNX:	INC	HL
	INC	DE
	DJNZ	LPE
	LD	A,C
	LD	(STOPPARTS),A
	JR	PLAYLOOP
;	JR	HOOKWRK

PSTOP:	XOR	A
	LD	HL,ENDFRG
	DEC	(HL)
	LD	(HL),A;0
	JR	NZ,HOOKWRK

	LD	HL,LOOPTIME
;	XOR	A
	OR	(HL)

	JR	Z,HOOKWRK

	DEC	(HL)
	JR	NZ,PLAYLOOP
	JP	STOP

;	LD	H,0
;	LD	A,(NSAVE)
;	LD	L,A
;	CALL	INITIAL
HOOKWRK:DB	0,0C9H,0C9H,0C9H,0C9H
;	RET

	;ÃÝÎß¦Ê¶Ù

PING:	LD	HL,OFFSET
	ADD	HL,BC
	ADD	HL,BC

	LD	E,(HL)
	INC	HL
	LD	D,(HL)	;Ê²Ê² ÃÞ-ÀÉÊÞÝÁ

PINGPONG:LD	A,(DE)

	CP	225
	JP	C,PLAY

	PUSH	HL
	DEC	DE;*

	CALL	COMAND
	POP	HL
	DEC	DE;*
;	CALL	STCOUNT

	JR	PINGPONG

COMAND:	CP	226
	JR	Z,CHNVOL
	CP	227
	JR	Z,LEN
	CP	225
	JR	Z,YCOM
;	CP	255
	INC	A
	JR	Z,D.C.
;	CP	254
	INC	A
	RET	NZ

	CALL	SYNCON
	PUSH	DE
	CALL	NOPUT
	POP	DE

SUTETA:	POP	HL;ØÀ-Ý±ÄÞÚ½
;	POP	HL;½À¯¸
	LD	A,1
	JP	LENG

;	RET	;Ò²ÝÙ-ÌßÆÓÄÞØÏ½

;BC->PART DE->DATAADR ADR HL->FREE

SYNCON:	LD	HL,STOPFRG
	ADD	HL,BC
	LD	(HL),254
	INC	DE;*

SYNCFGON:LD	HL,STOPPARTS
	INC	(HL)
	RET

CHNVOL:	LD	A,(DE)
	LD	HL,MAXVOL
	ADD	HL,BC
	LD	(HL),A
	RET

LEN:	LD	A,(DE)
	LD	HL,LENGTH
	ADD	HL,BC
	LD	(HL),A
	RET

YCOM:	LD	A,(DE)
	LD	H,A
	DEC	DE;*
	LD	A,(DE)
	PUSH	DE;
	LD	E,A
	LD	A,H
	CALL	WRTPSG
	POP	DE
	RET

D.C.:	LD	HL,STARTADR
	ADD	HL,BC
	ADD	HL,BC
	;CALL	SADGET
	LD	E,(HL)
	INC	HL
	LD	D,(HL)
	INC	DE;*

;	LD	HL,LOOPTIME
;	LD	A,(HL)
;	OR	A
;	RET	Z
;	DEC	(HL)
;	RET	NZ

	LD	A,1
	LD	(ENDFRG),A
	RET
;	JR	SUTETA

;SKIPDATA:LD	A,(DE)	;ÔØ¶À¼ÀÞ²ÃÞ
;	LD	L,A	;¶Ü¾ÙÉÃÞ
;	INC	DE	;²ÏÊÏÀÞ
;	LD	A,(DE)	;ÈÑ¯Ã²Ù
;	LD	H,A
;	ADD	HL,DE
;	LD	E,L
;	LD	D,H
;	RET

;PSG Æ µÄÃÞ-À ¦ ¼­ÂØ®¸ ½Ù Ù-ÁÝ ÀÞÖ

PLAY:	PUSH	HL
	AND	01111111B
	CALL	PSGPUT
	LD	A,(DE)
	AND	10000000B
;	PUSH	HL
	LD	HL,LENGTH
	ADD	HL,BC
	LD	A,(HL)
;	POP	HL
	JR	NZ,LENG

	DEC	DE;*
	LD	A,(DE)

LENG:	LD	HL,COUNT
	ADD	HL,BC
	LD	(HL),A
	POP	HL

STCOUNT:DEC	DE;*
	LD	(HL),D
	DEC	HL
	LD	(HL),E
	RET

PSGPUT:	PUSH	DE
	PUSH	HL
	LD	HL,STOPFRG
	ADD	HL,BC
	LD	(HL),A

	SLA	A
	LD	E,A
	LD	D,0

	LD	HL,PSGDATA
	ADD	HL,DE	;TONEÉ¶¸É³ÊÞÝÁ

	LD	A,C
	SLA	A
	LD	E,(HL)
	CALL	WRTPSG
	INC	HL

	INC	A
	LD	E,(HL)
	CALL	WRTPSG
	CALL	PUTMVOL

	POP	HL
	POP	DE
	RET

PUTMVOL:LD	HL,STOPFRG
	ADD	HL,BC
	LD	A,(HL)
	OR	A
	JR	Z,PUTVOL;·­³ÌÃÞÅ²Å×
	LD	HL,MAXVOL
	ADD	HL,BC
	LD	A,(HL)

PUTVOL:	CP	16
	CALL	NC,PUTENV

	LD	E,A
	LD	A,(FEEDVOL)
	LD	D,A
	LD	A,E
	SUB	D
	JR	NC,YESPUT
NOPUT:	XOR	A
YESPUT:	LD	E,A
	
	LD	A,8
	ADD	A,C
	JP	WRTPSG	;º³¼Ã ÂÈÆµÄ¦ÀÞ½
	
PUTENV:	ADD	A,-16
	LD	E,A
	LD	A,13
	CALL	WRTPSG
	LD	A,16
	RET
;SETLOOPS:LD	A,(PARTSUU)
;	LD	B,A
;	RET

;GETADR:	LD	HL,OFFSET
;	ADD	HL,BC
;	ADD	HL,BC	;2¶²À¼Ã ¼®³ÌÞÀÞÅ
;	RET

;	ORG	0DE1EH

COUNT:	DB	1,1,1	;µÝÁ®³¶³ÝÀ
;VOL:	DB	0,0,0	;µÄÅÝÊÞ-
STOPFRG:DB	0,0,0	;WAIT&SYNC&OFF
MAXVOL:	DB	15,15,15;ÎÞØ­-Ñ
LENGTH:	DB	5,5,5	;·ÎÝµÝÁ®³

OFFSET:	DB	0,0,0,0,0,0	;¶¸É³ADR
STARTADR:DB	0,0,0,0,0,0	;¶²¼
;PARTSUU:DB	3	;Êß-Ä½³(3)
FEEDVOL:DB	0	;Ìª-ÄÞ±³ÄÚÍÞÙ
FCOUNT:DB	1	;Ìª-ÄÞ¶³ÝÀ
;FEEDTIME:DB	12	;¼Þ¶Ý
LOOPTIME:DB	0	;Ù-Ìß¶²½³(0Ñ¹ÞÝ)
STOPPARTS:DB	0	;
ENDFRG:	DB	0
NSAVE:DB	0
	END
